{% extends "base.html" %}

{% block title %}Portal OCR | Panou{% endblock %}

{% block content %}
<section class="card">
    <h1>Proceseaza un document</h1>
    <p>Incarca un fisier PDF, alege limbile dorite si ruleaza OCR prin OCRmyPDF.</p>
    <form method="post" enctype="multipart/form-data" class="upload-form">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <div class="form-grid">
            <div class="form-control">
                <label for="{{ form.pdf_file.id_for_label }}">Fisier PDF</label>
                {{ form.pdf_file }}
                <small class="help-text">{{ form.pdf_file.help_text }}</small>
                {{ form.pdf_file.errors }}
            </div>
            <div class="form-control">
                <label for="{{ form.languages.id_for_label }}">Limbi pentru OCR</label>
                {{ form.languages }}
                <small class="help-text">{{ form.languages.help_text }}</small>
                {{ form.languages.errors }}
            </div>
        </div>
        <button type="submit" class="primary-button">Porneste OCR</button>
    </form>
</section>

<section class="card">
    <h2>Istoric procesari</h2>
    {% if jobs %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Creat</th>
                        <th>Document</th>
                        <th>Limbi</th>
                        <th>Status</th>
                        <th>Actiuni</th>
                    </tr>
                </thead>
                <tbody>
                {% for job in jobs %}
                    <tr class="status-{{ job.status }}">
                        <td>{{ job.created_at|date:"d.m.Y H:i" }}</td>
                        <td><a href="{{ job.source_file.url }}" target="_blank" rel="noopener">{{ job.source_file.name|cut:"uploads/" }}</a></td>
                        <td>{{ job.language_labels }}</td>
                        <td>
                            {% if job.status == job.Status.COMPLETED %}
                                <span class="badge badge-success">Finalizat</span>
                            {% elif job.status == job.Status.PROCESSING %}
                                <span class="badge badge-pending">In procesare</span>
                            {% elif job.status == job.Status.FAILED %}
                                <span class="badge badge-failed">Esuat</span>
                            {% else %}
                                <span class="badge">{{ job.get_status_display }}</span>
                            {% endif %}
                            {% if job.error_message %}
                                <div class="error-text">{{ job.error_message }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if job.status == job.Status.COMPLETED and job.processed_file %}
                                <a class="secondary-button" href="{% url 'portal:download' job.id %}">Descarca</a>
                            {% else %}
                                <span class="muted-text">N/A</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>Nu exista inca documente procesate. Incarca primul tau PDF de mai sus.</p>
    {% endif %}
</section>
{% endblock %}
