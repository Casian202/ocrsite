{% extends "base.html" %}

{% block title %}OCR Studio | OCR Workspace{% endblock %}

{% block content %}
<section class="section-header">
    <div>
        <h1>OCR Studio</h1>
        <p>Procesează PDF-uri folosind motorul <strong>{{ engine_label }}</strong> selectat de administrator.</p>
        {% if engine_key == 'docling' %}
            <p class="muted">Opțiunile avansate sunt interpretate de Docling. Unele setări pot fi ignorate de acest motor.</p>
            {% if not docling_available %}
                <p class="error-text">Docling nu este instalat în mediul curent. Cere administratorului să instaleze pachetul <code>docling</code>.</p>
            {% endif %}
        {% endif %}
    </div>
    <div class="badge">
        {% if engine_key == 'ocrmypdf' %}
            OCRmyPDF {{ ocrmypdf_version|default:"" }}
        {% else %}
            Docling
        {% endif %}
    </div>
</section>

<section class="card-grid">
    <article class="card">
        <h2>Configurează o nouă procesare</h2>
        <form method="post" enctype="multipart/form-data" class="form-grid">
            {% csrf_token %}
            <div class="form-field full-width">
                {{ form.pdf_file.label_tag }}
                {{ form.pdf_file }}
                <small class="help-text">{{ form.pdf_file.help_text }}</small>
                {{ form.pdf_file.errors }}
            </div>
            <div class="form-field toggle-field">
                {{ form.auto_language }}
                {{ form.auto_language.errors }}
            </div>
            <div class="form-field language-field" data-language-field>
                <label for="{{ form.languages.id_for_label }}">{{ form.languages.label }}</label>
                <button type="button" class="language-button" data-language-toggle aria-expanded="false" aria-controls="language-dropdown">
                    <span data-language-summary>Selectează limbile</span>
                    <span class="language-button__caret" aria-hidden="true">▾</span>
                </button>
                <div id="language-dropdown" class="language-dropdown" data-language-dropdown>
                    {{ form.languages }}
                    <small class="help-text">{{ form.languages.help_text }}</small>
                    {{ form.languages.errors }}
                </div>
            </div>
            <div class="form-field">
                {{ form.destination_folder.label_tag }}
                {{ form.destination_folder }}
                <small class="help-text">{{ form.destination_folder.help_text }}</small>
                {{ form.destination_folder.errors }}
            </div>
            <div class="advanced-actions full-width">
                <button type="button" class="advanced-trigger" data-advanced-open>
                    ⚙️ Setări avansate
                </button>
            </div>
            <div class="advanced-overlay" data-advanced-overlay hidden>
                <div class="advanced-overlay__backdrop" data-advanced-close></div>
                <div class="advanced-overlay__content" role="dialog" aria-modal="true" aria-labelledby="advanced-settings-title">
                    <div class="advanced-overlay__header">
                        <h3 id="advanced-settings-title" class="advanced-overlay__title">Setări avansate</h3>
                        <button type="button" class="advanced-overlay__close" data-advanced-close aria-label="Închide setările">×</button>
                    </div>
                    <div class="advanced-grid">
                        <div class="form-field">
                            {{ form.optimize_level.label_tag }}
                            {{ form.optimize_level }}
                            <small class="help-text">{{ form.optimize_level.help_text }}</small>
                        </div>
                        <div class="advanced-grid__toggles">
                            {{ form.deskew }}
                            {{ form.rotate_pages }}
                            {{ form.remove_background }}
                            {{ form.clean_final }}
                            {{ form.skip_text }}
                            {{ form.force_ocr }}
                            {{ form.make_sidecar }}
                        </div>
                        <div class="form-field">
                            {{ form.output_type.label_tag }}
                            {{ form.output_type }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-actions full-width">
                <button type="submit" class="primary-button">Pornește OCR</button>
            </div>
        </form>
    </article>

    <article class="card">
        <div class="card-header-row">
            <h2>Istoric ultimele procesări</h2>
            {% if jobs %}
                <div class="job-history-tools">
                    <label class="sr-only" for="job-history-search">Caută în istoricul procesărilor</label>
                    <input
                        type="search"
                        id="job-history-search"
                        class="job-search"
                        placeholder="Caută procesări"
                        autocomplete="off"
                        data-job-search
                        aria-label="Caută în istoricul procesărilor"
                    />
                </div>
            {% endif %}
        </div>
        {% if jobs %}
            <ul class="job-list" data-job-list>
                {% for job in jobs %}
                    <li
                        class="job-item job-item--{{ job.status }}"
                        data-job-item
                        data-job-title="{{ job.processed_filename|default:job.source_file.name|escape }}"
                        data-job-meta="{{ job.language_labels|escape }}{% if job.destination_folder %} {{ job.destination_folder.name|escape }}{% endif %}"
                    >
                        <div class="job-item__details">
                            <h3 class="job-item__title">{{ job.processed_filename|default:job.source_file.name }}</h3>
                            <p class="muted">Creat {{ job.created_at|date:"d.m.Y H:i" }} · Limbi: {{ job.language_labels }}</p>
                            {% if job.destination_folder %}
                                <p class="muted">Arhivat în: {{ job.destination_folder.name }}</p>
                            {% endif %}
                            {% if job.error_message %}
                                <p class="error-text">{{ job.error_message }}</p>
                            {% endif %}
                        </div>
                        <div class="job-actions" role="group" aria-label="Acțiuni procesare">
                            <span class="status-chip status-chip--{{ job.status }}">{{ job.get_status_display }}</span>
                            <div class="job-menu" data-job-menu>
                                <button
                                    type="button"
                                    class="job-menu__toggle"
                                    data-job-menu-toggle
                                    aria-haspopup="menu"
                                    aria-expanded="false"
                                    aria-controls="job-menu-{{ job.id }}"
                                >
                                    <span class="sr-only">Deschide meniul de acțiuni pentru {{ job.processed_filename|default:job.source_file.name }}</span>
                                    <svg aria-hidden="true" focusable="false" viewBox="0 0 24 24">
                                        <path d="M5 12a2 2 0 1 1 4 0 2 2 0 0 1-4 0zm5 0a2 2 0 1 1 4 0 2 2 0 0 1-4 0zm5 0a2 2 0 1 1 4 0 2 2 0 0 1-4 0z" />
                                    </svg>
                                </button>
                                <div
                                    class="job-menu__panel"
                                    id="job-menu-{{ job.id }}"
                                    role="menu"
                                    hidden
                                    data-job-menu-panel
                                >
                                    <ul class="job-menu__list">
                                        {% if job.status == 'completed' %}
                                            <li class="job-menu__entry" role="none">
                                                <a
                                                    href="{% url 'portal:download_job' job.id %}"
                                                    class="job-menu__action"
                                                    role="menuitem"
                                                    data-job-menu-item
                                                >
                                                    <svg aria-hidden="true" focusable="false" viewBox="0 0 24 24">
                                                        <path d="M12 3a1 1 0 0 1 1 1v8.586l2.293-2.293a1 1 0 1 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4a1 1 0 1 1 1.414-1.414L11 12.586V4a1 1 0 0 1 1-1zM5 17a1 1 0 0 1 1-1h12a1 1 0 1 1 0 2H6a1 1 0 0 1-1-1z" />
                                                    </svg>
                                                    <span>Descarcă PDF</span>
                                                </a>
                                            </li>
                                            <li class="job-menu__entry" role="none">
                                                <a
                                                    href="{% url 'portal:assign_job_folder' job.id %}"
                                                    class="job-menu__action"
                                                    role="menuitem"
                                                    data-job-menu-item
                                                >
                                                    <svg aria-hidden="true" focusable="false" viewBox="0 0 24 24">
                                                        <path d="M3 6a2 2 0 0 1 2-2h5.172a2 2 0 0 1 1.414.586L12.586 6H19a2 2 0 0 1 2 2v8a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V6zm2 0v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V9H11.414l-2-2H5z" />
                                                    </svg>
                                                    <span>Salvează în folder</span>
                                                </a>
                                            </li>
                                            {% if job.sidecar_file %}
                                                <li class="job-menu__entry" role="none">
                                                    <a
                                                        href="{% url 'portal:download_sidecar' job.id %}"
                                                        class="job-menu__action"
                                                        role="menuitem"
                                                        data-job-menu-item
                                                    >
                                                        <svg aria-hidden="true" focusable="false" viewBox="0 0 24 24">
                                                            <path d="M7 2a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V9.828a2 2 0 0 0-.586-1.414l-4.828-4.828A2 2 0 0 0 12.172 3H7zm7 2.414L17.586 8H14a1 1 0 0 1-1-1V4.414zM9 11h6a1 1 0 1 1 0 2H9a1 1 0 1 1 0-2zm0 4h4a1 1 0 1 1 0 2H9a1 1 0 0 1 0-2z" />
                                                        </svg>
                                                        <span>Descarcă text</span>
                                                    </a>
                                                </li>
                                            {% endif %}
                                        {% endif %}
                                        <li class="job-menu__entry" role="none">
                                            <form
                                                method="post"
                                                action="{% url 'portal:delete_job' job.id %}"
                                                class="job-delete-form"
                                                data-confirm-delete
                                                data-job-name="{{ job.processed_filename|default:job.source_file.name|escape }}"
                                            >
                                                {% csrf_token %}
                                                <button
                                                    type="submit"
                                                    class="job-menu__action job-menu__action--danger"
                                                    role="menuitem"
                                                    data-job-menu-item
                                                >
                                                    <svg aria-hidden="true" focusable="false" viewBox="0 0 24 24">
                                                        <path d="M9 3a1 1 0 0 0-1 1v1H5a1 1 0 1 0 0 2h1v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7h1a1 1 0 1 0 0-2h-3V4a1 1 0 0 0-1-1H9zm1 3h4V5h-4v1zm-1 3a1 1 0 0 1 2 0v8a1 1 0 1 1-2 0V9zm6-1a1 1 0 0 1 1 1v8a1 1 0 1 1-2 0V9a1 1 0 0 1 1-1z" />
                                                    </svg>
                                                    <span>Șterge din istoric</span>
                                                </button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
            <p class="muted job-empty" data-job-empty hidden>Nu există rezultate pentru căutarea curentă.</p>
        {% else %}
            <p class="muted">Nu există încă procesări. Încarcă un PDF pentru a porni primul job.</p>
        {% endif %}
    </article>
</section>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const autoToggle = document.querySelector('input[name="auto_language"]');
        const languageField = document.querySelector('[data-language-field]');
        const languageButton = document.querySelector('[data-language-toggle]');
        const languageDropdown = document.querySelector('[data-language-dropdown]');
        const languageSummary = document.querySelector('[data-language-summary]');
        const languageSelect = languageField ? languageField.querySelector('select') : null;

        const updateLanguageSummary = () => {
            if (!languageSelect || !languageSummary) return;
            const selected = Array.from(languageSelect.selectedOptions).map((option) => option.text.trim());
            if (!selected.length) {
                languageSummary.textContent = 'Selectează limbile';
            } else if (selected.length <= 2) {
                languageSummary.textContent = selected.join(', ');
            } else {
                languageSummary.textContent = `${selected.length} limbi selectate`;
            }
        };

        const closeLanguageDropdown = () => {
            if (languageDropdown && languageButton) {
                languageDropdown.classList.remove('is-open');
                languageButton.setAttribute('aria-expanded', 'false');
            }
        };

        const updateLanguageVisibility = () => {
            if (!languageField || !autoToggle) return;
            const hide = autoToggle.checked;
            languageField.hidden = hide;
            if (hide) {
                closeLanguageDropdown();
            }
        };

        if (languageButton && languageDropdown) {
            languageButton.addEventListener('click', (event) => {
                event.preventDefault();
                const isOpen = languageDropdown.classList.toggle('is-open');
                languageButton.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            });

            document.addEventListener('click', (event) => {
                if (!languageField || languageField.contains(event.target)) {
                    return;
                }
                closeLanguageDropdown();
            });
        }

        if (languageSelect) {
            languageSelect.addEventListener('change', updateLanguageSummary);
            updateLanguageSummary();
        }

        const languageErrors = languageDropdown ? languageDropdown.querySelector('.errorlist') : null;
        if (languageErrors && languageButton && languageDropdown) {
            languageField.hidden = false;
            languageDropdown.classList.add('is-open');
            languageButton.setAttribute('aria-expanded', 'true');
        }

        if (autoToggle) {
            autoToggle.addEventListener('change', () => {
                updateLanguageVisibility();
            });
            updateLanguageVisibility();
        }

        const advancedOverlay = document.querySelector('[data-advanced-overlay]');
        const advancedOpen = document.querySelector('[data-advanced-open]');
        const advancedClosers = document.querySelectorAll('[data-advanced-close]');

        const focusableSelector = 'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';

        const focusFirstElement = () => {
            if (!advancedOverlay) return;
            const focusable = advancedOverlay.querySelectorAll(focusableSelector);
            if (focusable.length) {
                focusable[0].focus({ preventScroll: true });
            }
        };

        const openAdvanced = () => {
            if (!advancedOverlay) return;
            advancedOverlay.hidden = false;
            advancedOverlay.classList.add('is-open');
            document.body.classList.add('modal-open');
            focusFirstElement();
        };

        const closeAdvanced = () => {
            if (!advancedOverlay) return;
            advancedOverlay.classList.remove('is-open');
            advancedOverlay.hidden = true;
            document.body.classList.remove('modal-open');
            if (advancedOpen) {
                advancedOpen.focus({ preventScroll: true });
            }
        };

        if (advancedOpen) {
            advancedOpen.addEventListener('click', (event) => {
                event.preventDefault();
                openAdvanced();
            });
        }

        advancedClosers.forEach((button) => {
            button.addEventListener('click', (event) => {
                event.preventDefault();
                closeAdvanced();
            });
        });

        const jobList = document.querySelector('[data-job-list]');
        const jobSearchInput = document.querySelector('[data-job-search]');
        const jobEmptyState = document.querySelector('[data-job-empty]');
        const jobItems = jobList ? Array.from(jobList.querySelectorAll('[data-job-item]')) : [];
        const jobMenuElements = jobList ? Array.from(jobList.querySelectorAll('[data-job-menu]')) : [];
        let activeJobMenu = null;

        const closeJobMenu = (menu, { restoreFocus = false } = {}) => {
            if (!menu) {
                return;
            }
            const toggle = menu.querySelector('[data-job-menu-toggle]');
            const panel = menu.querySelector('[data-job-menu-panel]');
            if (panel) {
                panel.hidden = true;
                panel.classList.remove('is-open');
            }
            if (toggle) {
                toggle.setAttribute('aria-expanded', 'false');
                if (restoreFocus) {
                    toggle.focus({ preventScroll: true });
                }
            }
            menu.classList.remove('is-open');
            if (activeJobMenu === menu) {
                activeJobMenu = null;
            }
        };

        const openJobMenu = (menu) => {
            if (!menu) {
                return;
            }
            const toggle = menu.querySelector('[data-job-menu-toggle]');
            const panel = menu.querySelector('[data-job-menu-panel]');
            if (panel) {
                panel.hidden = false;
                panel.classList.add('is-open');
            }
            if (toggle) {
                toggle.setAttribute('aria-expanded', 'true');
            }
            menu.classList.add('is-open');
            activeJobMenu = menu;
            const firstAction = panel ? panel.querySelector('[data-job-menu-item]') : null;
            if (firstAction) {
                firstAction.focus({ preventScroll: true });
            }
        };

        const closeAllJobMenus = (exceptMenu = null, { restoreFocus = false } = {}) => {
            jobMenuElements.forEach((menu) => {
                if (menu !== exceptMenu) {
                    const shouldRestore = restoreFocus && menu === activeJobMenu;
                    closeJobMenu(menu, { restoreFocus: shouldRestore });
                }
            });
        };

        const normalizeText = (value) =>
            (value || '')
                .toString()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase();

        const filterJobItems = () => {
            if (!jobItems.length) {
                return;
            }

            const term = normalizeText(jobSearchInput ? jobSearchInput.value.trim() : '');
            let visibleCount = 0;

            jobItems.forEach((item) => {
                const haystack = normalizeText(
                    `${item.dataset.jobTitle || ''} ${item.dataset.jobMeta || ''}`,
                );
                const matches = !term || haystack.includes(term);
                item.hidden = !matches;
                if (matches) {
                    visibleCount += 1;
                }
            });

            if (jobEmptyState) {
                jobEmptyState.hidden = visibleCount !== 0;
            }
        };

        jobMenuElements.forEach((menu) => {
            const toggle = menu.querySelector('[data-job-menu-toggle]');
            const panel = menu.querySelector('[data-job-menu-panel]');
            const menuItems = panel ? Array.from(panel.querySelectorAll('[data-job-menu-item]')) : [];
            const jobItem = menu.closest('[data-job-item]');

            if (toggle) {
                toggle.addEventListener('click', (event) => {
                    event.preventDefault();
                    if (menu.classList.contains('is-open')) {
                        closeJobMenu(menu);
                    } else {
                        closeAllJobMenus(menu);
                        openJobMenu(menu);
                    }
                });
            }

            menuItems.forEach((item) => {
                item.addEventListener('click', () => {
                    closeJobMenu(menu);
                });
            });

            if (jobItem) {
                jobItem.addEventListener('dblclick', (event) => {
                    if (event.target.closest('[data-job-menu]')) {
                        return;
                    }
                    event.preventDefault();
                    if (menu.classList.contains('is-open')) {
                        closeJobMenu(menu);
                    } else {
                        closeAllJobMenus(menu);
                        openJobMenu(menu);
                    }
                });
            }
        });

        if (jobSearchInput && jobItems.length) {
            jobSearchInput.addEventListener('input', () => {
                filterJobItems();
                if (jobList) {
                    jobList.scrollTop = 0;
                }
            });
            jobSearchInput.addEventListener('search', () => {
                filterJobItems();
                if (jobList) {
                    jobList.scrollTop = 0;
                }
            });
            filterJobItems();
        }

        const jobDeleteForms = document.querySelectorAll('[data-confirm-delete]');
        jobDeleteForms.forEach((form) => {
            form.addEventListener('submit', (event) => {
                const name = form.dataset.jobName || 'această procesare';
                const shouldDelete = window.confirm(
                    `Sigur ștergi ${name} din istoricul procesărilor?`,
                );
                if (!shouldDelete) {
                    event.preventDefault();
                }
            });
        });

        document.addEventListener('click', (event) => {
            if (event.target.closest('[data-job-menu]')) {
                return;
            }
            closeAllJobMenus();
        });

        document.addEventListener('keydown', (event) => {
            if (event.key !== 'Escape') {
                return;
            }
            if (advancedOverlay && advancedOverlay.classList.contains('is-open')) {
                closeAdvanced();
                return;
            }
            if (languageDropdown && languageDropdown.classList.contains('is-open')) {
                closeLanguageDropdown();
            }
            if (jobMenuElements.some((menu) => menu.classList.contains('is-open'))) {
                closeAllJobMenus(null, { restoreFocus: true });
            }
        });
    });
</script>
{% endblock %}
